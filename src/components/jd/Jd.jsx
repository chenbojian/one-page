import { createResource, For, Index } from "solid-js"
import { createStore, produce } from 'solid-js/store'


async function loadData() {
    const watchedItems = await fetch('https://api.internal/api/jd/items/watched').then(res => res.json())
    const items = await fetch('https://api.internal/api/jd/items').then(res => res.json())
    // const watchedItems = JSON.parse('{"100101971398":{"name":"花王（KAO）免刷洗马桶清洁剂洁厕灵500ml*2浴室清洗剂洁厕剂马桶洁厕液除臭","notifyPrice":35},"100027925704":{"name":"三元极致有机纯牛奶整箱200ml*21盒 有机认证 礼盒装","notifyPrice":49},"100085823466":{"name":"花王（KAO）免刷洁厕灵500ml 免刷洗马桶清洁剂洁厕液厕所清洗去污渍除菌净味","notifyPrice":17},"8589412":{"name":"花王（KAO）进口洁厕灵 洁厕剂 厕所马桶清洁剂 洁厕灵除菌液 500ml","notifyPrice":17},"100080127287":{"name":"花王（KAO）免刷洗马桶清洁剂洁厕灵500ml浴室清洗剂洁厕剂马桶洁厕液除臭","notifyPrice":17},"100010592287":{"name":"伊利舒化奶 无乳糖牛奶整箱 全脂型220ml*24盒 礼盒装 低GI认证","notifyPrice":53},"100049553795":{"name":"花王（KAO）洁厕液洁厕灵马桶清洁剂洁厕宝厕所清洁剂泡泡 去1000ml组合装","notifyPrice":34},"100025494126":{"name":"Bio Island佰澳朗德 比奥岛 成人孕妇中老年牛乳钙软胶囊150粒/瓶*2澳大利亚","notifyPrice":180},"2919743":{"name":"Bio Island佰澳朗德比奥岛 成人孕妇中老年牛乳钙软胶囊 150粒/瓶 澳大利亚","notifyPrice":99},"100007494167":{"name":"潮庭优选潮汕牛肉丸150g 潮州特产火锅食材 生鲜关东煮烧烤空气炸锅","notifyPrice":7}}')
    // const items = JSON.parse('{"item_2919743":{"min_price":"99.00","name":"Bio Island佰澳朗德比奥岛 成人孕妇中老年牛乳钙软胶囊 150粒/瓶 澳大利亚","max_price":"106.92","price":"106.92","price_history":{"2025-01-05T14:33:18+00:00":"99.00","2025-01-05T14:39:09+00:00":"99.00","2025-01-11T10:51:47+00:00":"106.92","2025-01-12T10:51:46+00:00":"106.92"}},"item_100007494167":{"name":"潮庭优选潮汕牛肉丸150g 潮州特产火锅食材 生鲜关东煮烧烤空气炸锅","min_price":"23.61","max_price":"28.61","price":"28.61","price_history":{"2025-01-07T02:52:18+00:00":"25.61","2025-01-07T10:52:13+00:00":"25.61","2025-01-08T02:52:23+00:00":"25.61","2025-01-08T10:52:16+00:00":"26.61","2025-01-09T02:52:16+00:00":"23.61","2025-01-09T10:52:13+00:00":"23.61","2025-01-10T02:52:18+00:00":"23.61","2025-01-10T18:55:05+00:00":"26.61","2025-01-11T02:52:46+00:00":"26.61","2025-01-11T10:52:47+00:00":"26.61","2025-01-12T03:02:28+00:00":"28.61","2025-01-12T10:52:42+00:00":"28.61"}},"item_8589412":{"max_price":"20.81","name":"花王（KAO）进口洁厕灵 洁厕剂 厕所马桶清洁剂 洁厕灵除菌液 500ml","min_price":"18.81","price":"20.81","price_history":{"2024-12-31T14:18:34+00:00":"20.81","2024-12-31T14:19:04+00:00":"20.81","2025-01-01T02:51:45+00:00":"20.81","2025-01-01T18:56:39+00:00":"20.81","2025-01-02T02:51:46+00:00":"20.81","2025-01-04T02:56:10+00:00":"20.81","2025-01-04T18:56:35+00:00":"20.81","2025-01-05T03:12:53+00:00":"18.81","2025-01-05T10:51:45+00:00":"18.81","2025-01-05T14:33:20+00:00":"18.81","2025-01-05T14:39:12+00:00":"18.81","2025-01-06T02:54:59+00:00":"20.81","2025-01-06T10:51:49+00:00":"20.81","2025-01-07T02:51:54+00:00":"20.81","2025-01-07T10:51:49+00:00":"20.81","2025-01-08T02:51:53+00:00":"20.81","2025-01-08T10:51:50+00:00":"18.81","2025-01-09T02:51:52+00:00":"18.81","2025-01-09T10:51:49+00:00":"18.81","2025-01-10T02:51:53+00:00":"18.81","2025-01-10T18:54:21+00:00":"18.81","2025-01-12T03:01:43+00:00":"20.81","2025-01-13T02:51:49+00:00":"20.81"}},"item_100101971398":{"name":"花王（KAO）免刷洗马桶清洁剂洁厕灵500ml*2浴室清洗剂洁厕剂马桶洁厕液除臭","max_price":"41.58","min_price":"37.52","price":"37.52","price_history":{"2024-12-31T15:46:48+00:00":"39.60","2025-01-01T02:51:50+00:00":"41.58","2025-01-01T18:56:44+00:00":"41.58","2025-01-02T02:51:48+00:00":"41.58","2025-01-02T18:51:50+00:00":"41.58","2025-01-03T02:56:23+00:00":"41.58","2025-01-03T18:51:51+00:00":"41.58","2025-01-04T02:56:15+00:00":"41.58","2025-01-04T15:17:31+00:00":"41.58","2025-01-04T18:56:40+00:00":"41.58","2025-01-05T03:12:56+00:00":"41.58","2025-01-05T10:51:49+00:00":"41.58","2025-01-05T14:33:23+00:00":"41.58","2025-01-05T14:39:15+00:00":"41.58","2025-01-06T02:55:01+00:00":"41.58","2025-01-06T10:51:51+00:00":"41.58","2025-01-07T02:51:56+00:00":"41.58","2025-01-07T10:51:51+00:00":"37.52","2025-01-08T10:51:53+00:00":"37.52","2025-01-09T02:51:54+00:00":"37.52","2025-01-09T10:51:51+00:00":"37.52","2025-01-10T02:51:55+00:00":"37.52","2025-01-10T18:54:27+00:00":"37.52","2025-01-11T02:52:04+00:00":"37.52","2025-01-11T10:51:59+00:00":"37.52","2025-01-12T03:01:49+00:00":"37.52","2025-01-12T10:52:00+00:00":"37.52","2025-01-13T02:51:52+00:00":"37.52"}},"item_100027925704":{"min_price":"47.41","name":"三元极致有机纯牛奶整箱200ml*21盒 有机认证 礼盒装","max_price":"52.16","price":"47.41","price_history":{"2024-12-31T15:46:52+00:00":"47.41","2025-01-01T02:51:54+00:00":"47.41","2025-01-01T18:56:48+00:00":"47.41","2025-01-02T02:51:50+00:00":"47.41","2025-01-02T18:51:55+00:00":"47.41","2025-01-03T02:56:27+00:00":"47.41","2025-01-03T18:51:58+00:00":"47.41","2025-01-04T02:56:21+00:00":"47.41","2025-01-04T15:17:35+00:00":"47.41","2025-01-04T18:56:44+00:00":"47.41","2025-01-05T03:12:58+00:00":"47.41","2025-01-05T10:51:53+00:00":"47.41","2025-01-05T14:33:25+00:00":"47.41","2025-01-05T14:39:17+00:00":"47.41","2025-01-06T02:55:03+00:00":"52.16","2025-01-06T10:51:53+00:00":"52.16","2025-01-07T02:51:58+00:00":"47.41","2025-01-07T10:51:54+00:00":"47.41","2025-01-08T02:51:58+00:00":"47.41","2025-01-08T10:51:55+00:00":"47.41","2025-01-09T02:51:56+00:00":"47.41","2025-01-09T10:51:54+00:00":"47.41","2025-01-10T02:51:58+00:00":"47.41","2025-01-10T18:54:32+00:00":"47.41","2025-01-11T02:52:10+00:00":"47.41","2025-01-11T10:52:06+00:00":"47.41","2025-01-12T03:01:55+00:00":"47.41","2025-01-12T10:52:07+00:00":"47.41","2025-01-13T02:51:54+00:00":"47.41"}},"item_100085823466":{"max_price":"21.68","name":"花王（KAO）免刷洁厕灵500ml 免刷洗马桶清洁剂洁厕液厕所清洗去污渍除菌净味","min_price":"19.68","price":"21.68","price_history":{"2024-12-31T15:46:55+00:00":"21.68","2025-01-01T02:51:58+00:00":"21.68","2025-01-01T18:56:52+00:00":"21.68","2025-01-02T02:51:52+00:00":"21.68","2025-01-02T18:51:59+00:00":"21.68","2025-01-03T02:56:31+00:00":"21.68","2025-01-03T18:52:05+00:00":"21.68","2025-01-04T02:56:26+00:00":"21.68","2025-01-04T15:17:38+00:00":"21.68","2025-01-04T18:56:50+00:00":"21.68","2025-01-05T03:13:00+00:00":"19.68","2025-01-05T10:51:58+00:00":"19.68","2025-01-05T14:33:27+00:00":"19.68","2025-01-05T14:39:20+00:00":"19.68","2025-01-06T02:55:05+00:00":"21.68","2025-01-06T10:51:56+00:00":"21.68","2025-01-07T02:52:02+00:00":"21.68","2025-01-07T10:51:56+00:00":"21.68","2025-01-08T02:52:00+00:00":"21.68","2025-01-08T10:51:58+00:00":"19.68","2025-01-09T02:51:59+00:00":"19.68","2025-01-09T10:51:56+00:00":"19.68","2025-01-10T02:52:01+00:00":"19.68","2025-01-10T18:54:37+00:00":"19.68","2025-01-11T02:52:17+00:00":"19.68","2025-01-11T10:52:12+00:00":"19.68","2025-01-12T03:02:01+00:00":"21.68","2025-01-12T10:52:12+00:00":"21.68","2025-01-13T02:51:56+00:00":"21.68"}},"item_100080127287":{"min_price":"20.20","name":"花王（KAO）免刷洗马桶清洁剂洁厕灵500ml浴室清洗剂洁厕剂马桶洁厕液除臭","max_price":"22.18","price":"20.30","price_history":{"2024-12-31T15:47:00+00:00":"20.20","2025-01-01T02:52:02+00:00":"22.18","2025-01-01T18:56:56+00:00":"22.18","2025-01-02T02:51:54+00:00":"22.18","2025-01-02T18:52:03+00:00":"22.18","2025-01-03T02:56:37+00:00":"22.18","2025-01-03T18:52:10+00:00":"22.18","2025-01-04T02:56:30+00:00":"22.18","2025-01-04T15:17:41+00:00":"22.18","2025-01-04T18:56:54+00:00":"22.18","2025-01-05T03:13:02+00:00":"22.18","2025-01-05T10:52:03+00:00":"22.18","2025-01-05T14:33:30+00:00":"22.18","2025-01-05T14:39:22+00:00":"22.18","2025-01-06T02:55:08+00:00":"22.18","2025-01-06T10:51:58+00:00":"22.18","2025-01-07T02:52:03+00:00":"22.18","2025-01-07T10:51:59+00:00":"20.30","2025-01-08T02:52:03+00:00":"20.30","2025-01-08T10:52:00+00:00":"20.30","2025-01-09T02:52:02+00:00":"20.30","2025-01-09T10:51:59+00:00":"20.30","2025-01-10T02:52:03+00:00":"20.30","2025-01-10T18:54:43+00:00":"20.30","2025-01-11T02:52:22+00:00":"20.30","2025-01-11T10:52:20+00:00":"20.30","2025-01-12T03:02:07+00:00":"20.30","2025-01-12T10:52:17+00:00":"20.30","2025-01-13T02:51:59+00:00":"20.30"}},"item_100010592287":{"name":"伊利舒化奶 无乳糖牛奶整箱 全脂型220ml*24盒 礼盒装 低GI认证","min_price":"49.38","max_price":"59.76","price":"59.76","price_history":{"2024-12-31T15:47:05+00:00":"54.06","2025-01-01T02:52:06+00:00":"54.06","2025-01-01T18:57:00+00:00":"54.06","2025-01-02T02:51:56+00:00":"54.06","2025-01-02T18:52:07+00:00":"54.06","2025-01-03T02:56:40+00:00":"54.06","2025-01-03T18:52:15+00:00":"54.06","2025-01-04T02:56:35+00:00":"54.06","2025-01-04T15:17:44+00:00":"54.06","2025-01-04T18:56:59+00:00":"54.06","2025-01-05T03:13:04+00:00":"52.06","2025-01-05T10:52:08+00:00":"52.06","2025-01-05T14:33:32+00:00":"52.06","2025-01-05T14:39:25+00:00":"52.06","2025-01-06T02:55:10+00:00":"56.91","2025-01-06T10:52:01+00:00":"56.91","2025-01-07T02:52:06+00:00":"56.91","2025-01-07T10:52:01+00:00":"51.38","2025-01-08T02:52:05+00:00":"51.38","2025-01-08T10:52:03+00:00":"49.38","2025-01-09T02:52:04+00:00":"57.30","2025-01-09T10:52:02+00:00":"57.30","2025-01-10T02:52:06+00:00":"54.91","2025-01-10T18:54:49+00:00":"54.91","2025-01-11T02:52:28+00:00":"54.91","2025-01-11T10:52:26+00:00":"54.91","2025-01-12T03:02:12+00:00":"56.91","2025-01-12T10:52:24+00:00":"56.91","2025-01-12T14:31:39+00:00":"56.91","2025-01-12T14:32:17+00:00":"56.91","2025-01-12T14:32:39+00:00":"56.91","2025-01-12T14:33:11+00:00":"56.91","2025-01-12T14:33:22+00:00":"56.91","2025-01-13T01:41:07+00:00":"59.76","2025-01-13T01:42:36+00:00":"59.76","2025-01-13T02:52:01+00:00":"59.76"}},"item_100049553795":{"max_price":"42.56","name":"花王（KAO）洁厕液洁厕灵马桶清洁剂洁厕宝厕所清洁剂泡泡 去1000ml组合装","min_price":"40.56","price":"42.56","price_history":{"2025-01-01T02:52:12+00:00":"42.56","2025-01-01T18:57:04+00:00":"42.56","2025-01-02T02:51:59+00:00":"42.56","2025-01-02T18:52:12+00:00":"42.56","2025-01-03T02:56:45+00:00":"42.56","2025-01-04T02:56:40+00:00":"42.56","2025-01-04T15:17:50+00:00":"42.56","2025-01-04T18:57:04+00:00":"42.56","2025-01-05T03:13:06+00:00":"40.56","2025-01-05T10:52:13+00:00":"40.56","2025-01-05T14:33:34+00:00":"40.56","2025-01-05T14:39:27+00:00":"40.56","2025-01-05T14:59:50+00:00":"42.56","2025-01-06T02:55:13+00:00":"42.56","2025-01-06T10:52:03+00:00":"42.56","2025-01-07T02:52:09+00:00":"42.56","2025-01-07T10:52:04+00:00":"42.56","2025-01-08T02:52:08+00:00":"42.56","2025-01-08T10:52:05+00:00":"40.56","2025-01-09T02:52:06+00:00":"40.56","2025-01-09T10:52:04+00:00":"40.56","2025-01-10T02:52:08+00:00":"40.56","2025-01-10T18:54:54+00:00":"40.56","2025-01-11T02:52:33+00:00":"40.56","2025-01-11T10:52:33+00:00":"40.56","2025-01-12T03:02:16+00:00":"42.56","2025-01-12T10:52:31+00:00":"42.56","2025-01-13T02:52:04+00:00":"42.56"}},"item_100025494126":{"name":"Bio Island佰澳朗德 比奥岛 成人孕妇中老年牛乳钙软胶囊150粒/瓶*2澳大利亚","min_price":"180.00","max_price":"215.00","price":"215.00","price_history":{"2025-01-05T14:33:39+00:00":"189.00","2025-01-05T14:39:32+00:00":"189.00","2025-01-05T14:56:20+00:00":"189.00","2025-01-06T02:55:20+00:00":"189.00","2025-01-07T02:52:15+00:00":"180.00","2025-01-07T10:52:11+00:00":"180.00","2025-01-09T02:52:12+00:00":"215.00","2025-01-09T10:52:09+00:00":"215.00","2025-01-10T02:52:14+00:00":"215.00","2025-01-10T18:55:00+00:00":"215.00","2025-01-11T02:52:39+00:00":"215.00","2025-01-11T10:52:40+00:00":"215.00","2025-01-12T03:02:23+00:00":"215.00","2025-01-12T10:52:37+00:00":"215.00","2025-01-13T02:52:12+00:00":"215.00"}}}')
    const getUpdatedAt = (item) => {
        if (!item.price_history) return null;
        const dates = Object.keys(item.price_history);
        if (dates.length > 0) {
            const latest = dates.sort().reverse()[0];
            const d = new Date(latest);
            d.setHours(d.getHours() + 8); // convert to UTC+8
            return d.toISOString().slice(0, 16).replace('T', ' ');
        }
        return null;
    }
    return Object.keys(watchedItems).map(i => ({
        id: i,
        name: watchedItems[i].name,
        notifyPrice: watchedItems[i].notifyPrice,
        price: items['item_' + i]?.price,
        minPrice: items['item_' + i]?.min_price,
        maxPrice: items['item_' + i]?.max_price,
        updatedAt: getUpdatedAt(items['item_' + i]),
        active: watchedItems[i].active
    }))
}



export default function () {
    const [state, setState] = createStore({
        items: [],
        item: {
            id: null,
            name: null,
            notifyPrice: null,
            active: true
        }
    })

    const [showAll, setShowAll] = createStore({ value: false });

    const init = () => {
        setState({
            items: [],
            item: {
                id: null,
                name: null,
                notifyPrice: null,
                active: true
            }

        })
        loadData().then(items => {
            setState('items', items.map(item => ({ ...item })))
        })
    }

    init()

    function toggleActive(index) {
        setState('items', index, 'active', !state.items[index].active);
        updateWatchedItem(state.items[index]);
    }

    async function updateWatchedItem(item) {
        await fetch('https://api.internal/api/jd/items/watched', {
            method: 'put',
            headers: {
                'content-type': 'application/json'
            },
            body: JSON.stringify({
                [item.id]: {
                    name: item.name,
                    notifyPrice: parseFloat(item.notifyPrice),
                    active: item.active
                }
            })
        })
    }

    return (
        <div className="w-full h-full">
            <div className="flex items-center m-3">
                <input
                    type="checkbox"
                    id="filterActive"
                    checked={!showAll.value}
                    onChange={(e) => setShowAll('value', !e.target.checked)}
                />
                <label htmlFor="filterActive" className="ml-2">Show only active items</label>
            </div>
            <For each={state.items}>
            {(item, index) => (
                <div className="text-left mb-3 ml-3 mr-3" classList={{ 'hidden': !showAll.value && !item.active }}>
                    <input type="checkbox" checked={item.active} onChange={() => toggleActive(index())} /> <strong>{item.name}</strong>
                    <div className="grid grid-cols-[40%,40%]">
                        <span className="">current: <strong>{item.price}</strong> ({item.updatedAt})</span>
                        <span className=" flex">
                            notify: <input className="w-16 border" type="number" value={item.notifyPrice} onBlur={(e) => {
                                setState('items', index(), 'notifyPrice', e.target.value);
                                updateWatchedItem(item);
                            }} />
                        </span>
                        <span className="">min: {item.minPrice}</span>
                        <span className="">max: {item.maxPrice}</span>
                    </div>

                </div>
            )}
            </For>
            <div className="flex flex-col m-3">
                <input className="flex-1 mb-1 p-1 border" type="text" placeholder="京东商品ID" value={state.item.id} onInput={(e) => setState('item', 'id', e.target.value)} />
                <input className="flex-1 mb-1 p-1 border" type="text" placeholder="京东商品名称" value={state.item.name} onInput={(e) => setState('item', 'name', e.target.value)} />
                <input className="flex-1 mb-1 p-1 border" type="number" placeholder="notifyPrice" value={state.item.notifyPrice} onInput={(e) => setState('item', 'notifyPrice', e.target.value)} />
                <button className="bg-slate-300 w-20" onClick={() => updateWatchedItem(state.item)}>Update</button>
            </div>
        </div>
    )
}
